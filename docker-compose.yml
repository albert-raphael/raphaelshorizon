services:
  app:
    build: .
    ports:
      - "5002:5002"
    environment:
      - NODE_ENV=production
      - MONGO_URI=mongodb+srv://albertraphael96_db_user:66SBACl6p5jBNDA9@authorbookswebsite.2byzlvu.mongodb.net/
      - JWT_SECRET=raphaels_horizon_jwt_secret_2024_secure_key_change_this_in_production
      - GOOGLE_CLIENT_ID=890457459901-tpah6030evi6btmtsq9q8s7f3mr19uor.apps.googleusercontent.com
      - GOOGLE_CLIENT_SECRET=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
      - FRONTEND_URL=https://raphaelshorizon.com
      - AUDIOBOOKSHELF_URL=https://raphaelshorizon.com/audiobookshelf
      - CALIBRE_WEB_URL=https://raphaelshorizon.com/calibre
      # PayPal Configuration (Sandbox for testing)
      - PAYPAL_CLIENT_ID=AdMeOS47eeLcF9yVGNFSDmYGYjGJMYWuJPds1tvZiMnoT2QHsZC-wfrMBGWcJ4jifD0NhxCehIG2WQeZ
      - PAYPAL_SECRET=EG-Q1Maq0b-2mAu3JhhOgpn3MKoYCLRZneaDohVYxdUCTzS3W0sHwIba4A3HBX6zXa5v4Vubw9kMhebK
      - PAYPAL_MODE=sandbox
      # Stripe Configuration (Test for testing)
      - STRIPE_PUBLIC_KEY=pk_test_51SpRqDFyeKaZeFqI5143tzaue8iJ9ZuZvbo6uFwaAvH3LmxT0wg0e3JNDfMBTmUWQmJ2OYVzHk5zT3Rk6gFBHG2400YoAmFuIn
      - STRIPE_SECRET_KEY=sk_test_51SpRqDFyeKaZeFqIef96gU55mTusKbR7anUMDCmaBrDknikDYkBgEmXaAXWxVg5UPTXxOnpNIfvWHTCO4hnjAAiH00Zu06s2ts
    volumes:
      - ./backend/uploads:/app/backend/uploads
      - ./backend/embedded-data:/app/backend/embedded-data
      - ./audiobooks:/app/audiobooks:ro
      - ./books:/app/books:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:alpine
    user: root
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend:/usr/share/nginx/html:ro
      - ./ssl:/etc/ssl/certs:ro
      - ./audiobooks:/audiobooks:ro
    depends_on:
      - app
    restart: unless-stopped

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    ports:
      - "13378:80"
    volumes:
      - ./audiobooks:/audiobooks:ro
      - ./books:/books:ro
      - ./audiobooks-config:/config
      - ./audiobooks-metadata:/metadata
    environment:
      - AUDIOBOOKSHELF_UID=1000
      - AUDIOBOOKSHELF_GID=1000
      - TZ=Europe/London
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  calibre-web:
    image: linuxserver/calibre-web:latest
    ports:
      - "8083:8083"
    volumes:
      - ./books:/books
      - ./calibre-config:/config
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/London
      - DOCKER_MODS=linuxserver/mods:universal-calibre
      - CALIBRE_WEB_PATH_PREFIX=/calibre
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:  # Optional: define a custom network
  default:
    name: raphaelshorizon-network
    driver: bridge